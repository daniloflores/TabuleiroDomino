<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Tabuleiro domino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>

    <canvas id="canvasTabuleiro" width="800" height="500" style="border: 1px solid #000">
      <h3>Navegador não possui suporte ao canvas</h3>
      <!-- Executa apenas se browser nao tiver suporte à tag canvas -->
    </canvas>

    <p>"Digite o numero da peça ex: 66"</p>
    <input type="text" id="pecaJogador" value="">
    <p>"Digite a ponta (1 ou 2)"</p>
    <input type="text" id="pontaJogador" value="">
    <button onclick=atualizaTabuleiro()>Adicionar peca</button>

    <script type="text/javascript">
      const tabuleiro = document.getElementById("canvasTabuleiro")
      const ctx = tabuleiro.getContext("2d")

      let l_tabuleiro = tabuleiro.width
      let a_tabuleiro = tabuleiro.height
      let centro_x = l_tabuleiro/2
      let centro_y = a_tabuleiro/2
      let l_peca_original = 198
      let a_peca_original = 100
      const reduc = 3

      var imagensPecas = {
        "66": "Imagens/Pecas_teste/6_6.png",
        "65": "Imagens/Pecas_teste/6_5.png",
        "64": "Imagens/Pecas_teste/6_4.png",
        "63": "Imagens/Pecas_teste/6_3.png",
        "62": "Imagens/Pecas_teste/6_2.png",
        "61": "Imagens/Pecas_teste/6_1.png",
        "60": "Imagens/Pecas_teste/6_0.png",
        "55": "Imagens/Pecas_teste/5_5.png",
        "54": "Imagens/Pecas_teste/5_4.png",
        "53": "Imagens/Pecas_teste/5_3.png",
        "52": "Imagens/Pecas_teste/5_2.png",
        "51": "Imagens/Pecas_teste/5_1.png",
        "50": "Imagens/Pecas_teste/5_0.png",
        "44": "Imagens/Pecas_teste/4_4.png",
        "43": "Imagens/Pecas_teste/4_3.png",
        "42": "Imagens/Pecas_teste/4_2.png",
        "41": "Imagens/Pecas_teste/4_1.png",
        "40": "Imagens/Pecas_teste/4_0.png",
        "33": "Imagens/Pecas_teste/3_3.png",
        "32": "Imagens/Pecas_teste/3_2.png",
        "31": "Imagens/Pecas_teste/3_1.png",
        "30": "Imagens/Pecas_teste/3_0.png",
        "22": "Imagens/Pecas_teste/2_2.png",
        "21": "Imagens/Pecas_teste/2_1.png",
        "20": "Imagens/Pecas_teste/2_0.png",
        "11": "Imagens/Pecas_teste/1_1.png",
        "10": "Imagens/Pecas_teste/1_0.png",
        "00": "Imagens/Pecas_teste/0_0.png"
      }
      //Conjunto de valores validos de pecas para usuario digitar
      pecasValidas = Object.keys(imagensPecas)
      nPecas = pecasValidas.length
      for (var i = 0; i < nPecas; i++) {
        pecasValidas.push(pecasValidas[i].split("").reverse().join(""))
      }

      class CadeiaDePecas {
        constructor(){
          this.arrayPecas = []
          this.tamanho = 0
          this.novaPeca
          this.pecaAnterior
          this.ponta1 = 0
          this.ponta2 = 0
          this.tamanhoLado1 = 0
          this.tamanhoLado2 = 0
          this.semZoom = true
          this.sentidoPonta1 = "esquerda"
          this.sentidoPonta2 = "direita"
        }

        AjustaCadeia(){

          if(cadeiaPecas.semZoom &&
            (cadeiaPecas.tamanhoLado1 > 4 ||  cadeiaPecas.tamanhoLado2 > 4)){
            zoomOut()
            cadeiaPecas.semZoom = false
          }

          if(this.tamanhoLado1  > 5 && this.sentidoPonta1 == "esquerda"){
            if (this.novaPeca.vertical==false && this.pecaAnterior.vertical==false){
              this.sentidoPonta1 = "curva para cima"
            } else {
              zoomOut(0.9)
            }
          }

          if(this.tamanhoLado2  > 5 && this.sentidoPonta2 == "direita"){
            if (this.novaPeca.vertical==false && this.pecaAnterior.vertical==false){
              this.sentidoPonta2 = "curva para baixo"
            } else {
              zoomOut(0.9)
            }
          }

        }

        PrimeiraPeca(numero){
          this.novaPeca = new Peca(numero)

          this.arrayPecas.push(this.novaPeca)

          this.novaPeca.x = centro_x
          this.novaPeca.y = centro_y

          this.tamanho = this.arrayPecas.length
        }

        AdicionaPeca(numero, ponta=1){
          this.novaPeca = new Peca(numero)

          if (ponta == 1){
            this.pecaAnterior = this.arrayPecas[0]
            this.arrayPecas.unshift(this.novaPeca)
            this.tamanhoLado1 ++
          } else if (ponta == 2){
            this.pecaAnterior = this.arrayPecas[this.tamanho-1]
            this.arrayPecas.push(this.novaPeca)
            this.tamanhoLado2 ++
          }

          this.tamanho = this.arrayPecas.length
        }

        AtualizaCoordenadasNovaPeca(ponta=1){
          let sentido
          let deslocX
          let deslocY

          if (ponta == 1){
            sentido = this.sentidoPonta1
          } else if (ponta == 2){
            sentido = this.sentidoPonta2
          }

          if(sentido == "esquerda"){
            deslocX = -this.pecaAnterior.larg/2 -this.novaPeca.larg/2
            deslocY = 0
          } else if (sentido == "cima"){
            this.novaPeca.Girar90graus()
            deslocX = 0
            deslocY = -this.pecaAnterior.alt/2 -this.novaPeca.alt/2
          } else if (sentido == "direita"){
            deslocX = +this.pecaAnterior.larg/2 +this.novaPeca.larg/2
            deslocY = 0
          } else if (sentido == "baixo"){
            this.novaPeca.Girar90graus()
            deslocX = 0
            deslocY = +this.pecaAnterior.alt/2 +this.novaPeca.alt/2
          } else if (sentido == "curva para cima"){
            this.novaPeca.Girar90graus()
            deslocX = -this.pecaAnterior.larg/4
            deslocY = -this.pecaAnterior.alt/2 -this.novaPeca.alt/2
            this.sentidoPonta1 = "cima"
            //Falta generalizar para a ponta 2
          } else if (sentido == "curva para baixo"){
            this.novaPeca.Girar90graus()
            deslocX = +this.pecaAnterior.larg/4
            deslocY = +this.pecaAnterior.alt/2 +this.novaPeca.alt/2
            this.sentidoPonta2 = "baixo"
            //Falta generalizar para a ponta 1
          }

          this.novaPeca.x = this.pecaAnterior.x + deslocX
          this.novaPeca.y = this.pecaAnterior.y + deslocY
        }

        MostrarCadeia(){
          if (this.arrayPecas[0]){
            mostrarPecas(this.arrayPecas,this.tamanho,0)
          } else {
            alert("Cadeia vazia")
          }
        }

      }

      class Peca {
        constructor(numero){

          this.numero = numero
          this.vertical = false
          this.invertida = false

          this.lado1 = parseInt(numero.charAt(0))
          this.lado2 = parseInt(numero.charAt(1))

          this.larg = l_peca_original/reduc
          this.alt = a_peca_original/reduc

          if(this.lado1 == this.lado2){
            this.vertical = true
            let placeholder = this.larg
            this.larg = this.alt
            this.alt = placeholder
          }

          if(this.lado1 < this.lado2){
            this.invertida = true
          }
        }

        Girar90graus(){
          this.vertical = !this.vertical
          let placeholder = this.larg
          this.larg = this.alt
          this.alt = placeholder
        }

      }

      function mostrarPecas(arrayPecas,tamanho,i){

        if (i < tamanho){
          let pecaImg = new Image()
          let pecaObj = arrayPecas[i]
          let img_x = pecaObj.x
          let img_y = pecaObj.y

          let numeroImg = ""
          if(pecaObj.invertida){
            numeroImg = pecaObj.numero.split("").reverse().join("")
          } else {
            numeroImg = pecaObj.numero
          }
          pecaImg.src = imagensPecas[numeroImg]

          pecaImg.addEventListener("load",()=>{
            //Esse eventlistener junto com a funcao recursiva abaixo
            //garante que cada peca soh eh processada e mostrarda
            //apos a peca anterior

            ctx.save()

            if(pecaObj.vertical){

              ctx.translate(img_x,img_y)
              ctx.rotate(Math.PI/2)
              ctx.drawImage(pecaImg,
                -pecaObj.alt/2,-pecaObj.larg/2,
                pecaObj.alt,pecaObj.larg)
              ctx.translate(-img_x,-img_y)

            } else if(pecaObj.invertida){

              ctx.translate(img_x,img_y)
              ctx.scale(-1,1)
              ctx.drawImage(pecaImg,
                +pecaObj.larg/2,-pecaObj.alt/2,
                -pecaObj.larg,pecaObj.alt)
              ctx.translate(-img_x,-img_y)

            } else {

              ctx.drawImage(pecaImg,
                img_x-pecaObj.larg/2,img_y-pecaObj.alt/2,
                pecaObj.larg,pecaObj.alt)

            }

            ctx.restore()

            mostrarPecas(arrayPecas,tamanho,i+1)
            //recursividade da funcao

          })
        }

      }

      function checarInput(pontaEscolhida,numeroEscolhido){
        if(pontaEscolhida!=1 && pontaEscolhida!=2){
          alert("Ponta inválida - Escolha '1' ou '2'")
          return "erro"
        }

        if(!pecasValidas.includes(numeroEscolhido)){
          alert("Numero de peca invalido")
          return "erro"
        }
      }

      let cadeiaPecas = new CadeiaDePecas()

      function atualizaTabuleiro(){

        let numeroEscolhido = document.getElementById("pecaJogador").value
        let pontaEscolhida = document.getElementById("pontaJogador").value

        if(checarInput(pontaEscolhida,numeroEscolhido)=="erro"){
          return
        }

        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)

        if(cadeiaPecas.tamanho==0){
          cadeiaPecas.PrimeiraPeca(numeroEscolhido)
        } else {
          cadeiaPecas.AdicionaPeca(numeroEscolhido, pontaEscolhida)
          cadeiaPecas.AjustaCadeia()
          cadeiaPecas.AtualizaCoordenadasNovaPeca(pontaEscolhida)
        }

        cadeiaPecas.MostrarCadeia()

      }

      function zoomOut(escala=.8){

        //let nova_largura = tabuleiro.width/
        //let nova_altura = tabuleiro.height
        //let sobra_largura = nova_largura - l_tabuleiro
        //let sobra_altura = nova_altura - a_tabuleiro

        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)

        ctx.translate(centro_x,centro_y)
        ctx.scale(escala,escala)
        ctx.translate(-centro_x,-centro_y)

        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)
      }

    </script>

  </body>
</html>
