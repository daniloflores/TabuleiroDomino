<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Tabuleiro domino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>

    <canvas id="canvasTabuleiro" width="800" height="500" style="border: 1px solid #000">
      <h3>Navegador não possui suporte ao canvas</h3>
      <!-- Executa apenas se browser nao tiver suporte à tag canvas -->
    </canvas>

    <p>"Digite o numero da peça ex: 66"</p>
    <input type="text" id="pecaJogador" value="">
    <p>"Digite a ponta (1 ou 2)"</p>
    <input type="text" id="pontaJogador" value="">
    <button onclick=atualizaTabuleiro()>Adicionar peca</button>
    <button onclick=zoomOut()>Zoom out</button>

    <script type="text/javascript">
      const tabuleiro = document.getElementById("canvasTabuleiro")
      const ctx = tabuleiro.getContext("2d")
      const reduc = 3

      let l_tabuleiro = tabuleiro.width
      let a_tabuleiro = tabuleiro.height
      let centro_x = l_tabuleiro/2
      let centro_y = a_tabuleiro/2
      let l_peca_original = 198
      let a_peca_original = 100


      var imagensPecas = {
        "66": "Imagens/Pecas_teste/6_6.png",
        "65": "Imagens/Pecas_teste/6_5.png",
        "64": "Imagens/Pecas_teste/6_4.png",
        "63": "Imagens/Pecas_teste/6_3.png",
        "62": "Imagens/Pecas_teste/6_2.png",
        "61": "Imagens/Pecas_teste/6_1.png",
        "60": "Imagens/Pecas_teste/6_0.png",
        "55": "Imagens/Pecas_teste/5_5.png",
        "54": "Imagens/Pecas_teste/5_4.png",
        "53": "Imagens/Pecas_teste/5_3.png",
        "52": "Imagens/Pecas_teste/5_2.png",
        "51": "Imagens/Pecas_teste/5_1.png",
        "50": "Imagens/Pecas_teste/5_0.png",
        "44": "Imagens/Pecas_teste/4_4.png",
        "43": "Imagens/Pecas_teste/4_3.png",
        "42": "Imagens/Pecas_teste/4_2.png",
        "41": "Imagens/Pecas_teste/4_1.png",
        "40": "Imagens/Pecas_teste/4_0.png",
        "33": "Imagens/Pecas_teste/3_3.png",
        "32": "Imagens/Pecas_teste/3_2.png",
        "31": "Imagens/Pecas_teste/3_1.png",
        "30": "Imagens/Pecas_teste/3_0.png",
        "22": "Imagens/Pecas_teste/2_2.png",
        "21": "Imagens/Pecas_teste/2_1.png",
        "20": "Imagens/Pecas_teste/2_0.png",
        "11": "Imagens/Pecas_teste/1_1.png",
        "10": "Imagens/Pecas_teste/1_0.png",
        "00": "Imagens/Pecas_teste/0_0.png"
      }
      //Conjunto de valores validos de pecas para usuario digitar
      pecasValidas = Object.keys(imagensPecas)
      nPecas = pecasValidas.length
      for (var i = 0; i < nPecas; i++) {
        pecasValidas.push(pecasValidas[i].split("").reverse().join(""))
      }

      class CadeiaDePecas {
        constructor(ponta1 = 0, ponta2 = 0, tamanho=0){
          this.arrayPecas = []
          this.ponta1 = 0
          this.ponta2 = 0
          this.tamanho = 0
          this.tamanhoLado1 = 0
          this.tamanhoLado2 = 0
          this.semZoom = true
          this.sentidoPonta1 = "horizontal"
          this.sentidoPonta2 = "horizontal"
        }

        PrimeiraPeca(numero){
          let novaPeca = new Peca(numero)

          this.arrayPecas.push(novaPeca)

          novaPeca.x = centro_x
          novaPeca.y = centro_y

          this.tamanho = this.arrayPecas.length
        }

        AdicionaPonta1(numero){

          let pecaAnterior = this.arrayPecas[0]
          let novaPeca = new Peca(numero)
          this.arrayPecas.unshift(novaPeca)

          if(this.sentidoPonta1 == "horizontal"){
            novaPeca.x = pecaAnterior.x - pecaAnterior.larg/2 - novaPeca.larg/2
            novaPeca.y = pecaAnterior.y
          } else if(this.sentidoPonta1 == "curva"){
            novaPeca.SetVertical()
            novaPeca.x = pecaAnterior.x - pecaAnterior.larg/4
            novaPeca.y = pecaAnterior.y - pecaAnterior.alt/2 - novaPeca.alt/2
            this.sentidoPonta1 = "vertical"
          } else if(this.sentidoPonta1 == "vertical"){
            novaPeca.SetVertical()
            novaPeca.x = pecaAnterior.x
            novaPeca.y = pecaAnterior.y - pecaAnterior.alt/2 - novaPeca.alt/2
          }

          this.tamanho = this.arrayPecas.length
          this.tamanhoLado1 ++

          if(cadeiaPecas.semZoom && cadeiaPecas.tamanhoLado1 > 4){
            zoomOut()
            cadeiaPecas.semZoom = false
          }

          if(this.tamanhoLado1  > 5 && this.sentidoPonta1 == "horizontal"){
            if (novaPeca.posicao=="horizontal" && pecaAnterior.posicao=="horizontal"){
              this.sentidoPonta1 = "curva"
            } else {
              zoomOut(0.9)
            }
          }

        }

        AdicionaPonta2(numero){
          let novaPeca = new Peca(numero)
          let pecaAnterior = this.arrayPecas[this.tamanho-1]
          this.arrayPecas.push(novaPeca)

          if(this.sentidoPonta2 == "horizontal"){
            novaPeca.x = pecaAnterior.x + pecaAnterior.larg/2 + novaPeca.larg/2
            novaPeca.y = pecaAnterior.y
          }else if(this.sentidoPonta2 == "curva"){
            novaPeca.SetVertical()
            novaPeca.x = pecaAnterior.x + pecaAnterior.larg/4
            novaPeca.y = pecaAnterior.y + pecaAnterior.alt/2 + novaPeca.alt/2
            this.sentidoPonta2 = "vertical"
          } else if(this.sentidoPonta2 == "vertical"){
            novaPeca.SetVertical()
            novaPeca.x = pecaAnterior.x
            novaPeca.y = pecaAnterior.y + pecaAnterior.alt/2 + novaPeca.alt/2
          }

          this.tamanho = this.arrayPecas.length
          this.tamanhoLado2 ++

          if(cadeiaPecas.semZoom && cadeiaPecas.tamanhoLado2 > 4){
            zoomOut()
            cadeiaPecas.semZoom = false
          }

          if(this.tamanhoLado2  > 5 && this.sentidoPonta2 == "horizontal"){
            if (novaPeca.posicao=="horizontal" && pecaAnterior.posicao=="horizontal"){
              this.sentidoPonta2 = "curva"
            } else {
              zoomOut(0.9)
            }
          }
        }

        MostrarCadeia(){
          if (this.arrayPecas[0]){
            mostrarPecas(this.arrayPecas,this.tamanho,0)
          } else {
            alert("Cadeia vazia")
          }
        }

      }

      class Peca {
        constructor(numero,posicao="horizontal"){

          this.numero = numero
          this.posicao = posicao
          this.vertical = false
          this.invertida = false

          this.lado1 = parseInt(numero.charAt(0))
          this.lado2 = parseInt(numero.charAt(1))

          this.larg = l_peca_original/reduc
          this.alt = a_peca_original/reduc

          if(this.lado1 == this.lado2){
            this.posicao = "vertical"
            let placeholder = this.larg
            this.larg = this.alt
            this.alt = placeholder
          }

          if(this.lado1 < this.lado2){
            this.posicao = "invertida"
          }
        }

        SetVertical(){
          this.posicao = "vertical"
          let placeholder = this.larg
          this.larg = this.alt
          this.alt = placeholder
        }

      }

      function mostrarPecas(arrayPecas,tamanho,i){

        if (i < tamanho){
          let pecaImg = new Image()
          let pecaObj = arrayPecas[i]
          let img_x = pecaObj.x
          let img_y = pecaObj.y

          let numeroImg = ""
          if(pecaObj.posicao == "invertida"){
            numeroImg = pecaObj.numero.split("").reverse().join("")
          } else {
            numeroImg = pecaObj.numero
          }
          pecaImg.src = imagensPecas[numeroImg]

          pecaImg.addEventListener("load",()=>{
            //Esse eventlistener junto com a funcao recursiva abaixo
            //garante que cada peca soh eh processada e mostrarda
            //apos a peca anterior

            ctx.save()

            if(pecaObj.posicao == "vertical"){

              ctx.translate(img_x,img_y)
              ctx.rotate(Math.PI/2)
              ctx.drawImage(pecaImg,
                -pecaObj.alt/2,-pecaObj.larg/2,
                pecaObj.alt,pecaObj.larg)
              ctx.translate(-img_x,-img_y)

            } else if(pecaObj.posicao == "invertida"){

              ctx.translate(img_x,img_y)
              ctx.scale(-1,1)
              ctx.drawImage(pecaImg,
                +pecaObj.larg/2,-pecaObj.alt/2,
                -pecaObj.larg,pecaObj.alt)
              ctx.translate(-img_x,-img_y)

            } else {

              ctx.drawImage(pecaImg,
                img_x-pecaObj.larg/2,img_y-pecaObj.alt/2,
                pecaObj.larg,pecaObj.alt)

            }

            ctx.restore()

            mostrarPecas(arrayPecas,tamanho,i+1)
            //recursividade da funcao

          })
        }

      }

      function checarInput(pontaEscolhida,numeroEscolhido){
        if(pontaEscolhida!=1 && pontaEscolhida!=2){
          alert("Ponta inválida - Escolha '1' ou '2'")
          return "erro"
        }

        if(!pecasValidas.includes(numeroEscolhido)){
          alert("Numero de peca invalido")
          return "erro"
        }
      }

      let cadeiaPecas = new CadeiaDePecas()

      function atualizaTabuleiro(){

        var numeroEscolhido = document.getElementById("pecaJogador").value
        var pontaEscolhida = document.getElementById("pontaJogador").value

        if(checarInput(pontaEscolhida,numeroEscolhido)=="erro"){
          return
        }

        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)

        if(cadeiaPecas.tamanho==0){
          cadeiaPecas.PrimeiraPeca(numeroEscolhido)
        } else if(pontaEscolhida==1){
          cadeiaPecas.AdicionaPonta1(numeroEscolhido)
        } else if (pontaEscolhida==2){
          cadeiaPecas.AdicionaPonta2(numeroEscolhido)
        }

        cadeiaPecas.MostrarCadeia()

      }

      function zoomOut(escala=.8){
        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)

        ctx.translate(centro_x,centro_y)
        ctx.scale(escala,escala)
        ctx.translate(-centro_x,-centro_y)

        cadeiaPecas.MostrarCadeia()
      }

    </script>

  </body>
</html>
