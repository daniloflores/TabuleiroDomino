<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Tabuleiro domino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>

    <canvas id="canvasTabuleiro" width="800" height="500" style="border: 1px solid #000">
      <h3>Navegador não possui suporte ao canvas</h3>
      <!-- Executa apenas se browser nao tiver suporte à tag canvas -->
    </canvas>

    <p>"Digite o numero da peça ex: 66"</p>
    <input type="text" id="pecaJogador" value="">
    <p>"Digite a ponta (1 ou 2)"</p>
    <input type="text" id="pontaJogador" value="">
    <button onclick=atualizaTabuleiro()>Adicionar peca</button>
    <button onclick=zoomOut()>Zoom out</button>

    <script type="text/javascript">
      const tabuleiro = document.getElementById("canvasTabuleiro")
      const ctx = tabuleiro.getContext("2d")

      let l_tabuleiro = tabuleiro.width
      let a_tabuleiro = tabuleiro.height
      let centro_x = l_tabuleiro/2
      let centro_y = a_tabuleiro/2
      let l_peca_original = 198
      let a_peca_original = 100
      let reduc = 3

      var imagensPecas = {
        "66": "Imagens/Pecas_teste/6_6.png",
        "65": "Imagens/Pecas_teste/6_5.png",
        "64": "Imagens/Pecas_teste/6_4.png",
        "63": "Imagens/Pecas_teste/6_3.png",
        "62": "Imagens/Pecas_teste/6_2.png",
        "61": "Imagens/Pecas_teste/6_1.png",
        "60": "Imagens/Pecas_teste/6_0.png",
        "55": "Imagens/Pecas_teste/5_5.png",
        "54": "Imagens/Pecas_teste/5_4.png",
        "53": "Imagens/Pecas_teste/5_3.png",
        "52": "Imagens/Pecas_teste/5_2.png",
        "51": "Imagens/Pecas_teste/5_1.png",
        "50": "Imagens/Pecas_teste/5_0.png",
        "44": "Imagens/Pecas_teste/4_4.png",
        "43": "Imagens/Pecas_teste/4_3.png",
        "42": "Imagens/Pecas_teste/4_2.png",
        "41": "Imagens/Pecas_teste/4_1.png",
        "40": "Imagens/Pecas_teste/4_0.png",
        "33": "Imagens/Pecas_teste/3_3.png",
        "32": "Imagens/Pecas_teste/3_2.png",
        "31": "Imagens/Pecas_teste/3_1.png",
        "30": "Imagens/Pecas_teste/3_0.png",
        "22": "Imagens/Pecas_teste/2_2.png",
        "21": "Imagens/Pecas_teste/2_1.png",
        "20": "Imagens/Pecas_teste/2_0.png",
        "11": "Imagens/Pecas_teste/1_1.png",
        "10": "Imagens/Pecas_teste/1_0.png",
        "00": "Imagens/Pecas_teste/0_0.png"
      }

      class CadeiaDePecas {
        constructor(ponta1 = 0, ponta2 = 0, tamanho=0){
          this.arrayPecas = []
          this.ponta1 = 0
          this.ponta2 = 0
          this.tamanho = 0
        }

        PrimeiraPeca(numero){
          let novaPeca = new Peca(numero)
          this.arrayPecas.push(novaPeca)
          novaPeca.x = centro_x - novaPeca.larg/2
          novaPeca.y = centro_y - novaPeca.alt/2
          this.tamanho = this.arrayPecas.length
        }

        AdicionaPonta1(numero){
          let novaPeca = new Peca(numero)
          let pecaAnterior = this.arrayPecas[0]

          this.arrayPecas.unshift(novaPeca)

          novaPeca.x = pecaAnterior.x - novaPeca.larg
          novaPeca.y = pecaAnterior.y

          this.tamanho = this.arrayPecas.length
        }

        AdicionaPonta2(numero){
          let novaPeca = new Peca(numero)
          let pecaAnterior = this.arrayPecas[this.tamanho-1]

          this.arrayPecas.push(novaPeca)

          novaPeca.x = pecaAnterior.x + pecaAnterior.larg/2 + novaPeca.larg/2
          novaPeca.y = pecaAnterior.y

          this.tamanho = this.arrayPecas.length
        }

        MostrarCadeia(){
          if (this.arrayPecas[0]){
            mostrarPecas(this.arrayPecas,this.tamanho,0)
          } else {
            alert("Cadeia vazia")
          }
        }

      }

      class Peca {
        constructor(numero,posicao="horizontal"){

          this.numero = numero
          this.posicao = posicao
          let placeholder

          this.lado1 = numero.charAt(0)
          this.lado2 = numero.charAt(1)

          this.larg = l_peca_original/reduc
          this.alt = a_peca_original/reduc

          if(this.lado1==this.lado2){
            this.posicao = "vertical"
          }

          //if (this.posicao=="vertical"){
            //placeholder = this.larg
            //this.larg = this.alt
            //this.alt = placeholder
          //}
          if (this.posição=="invertida"){
            placeholder = this.lado1
            this.lado1 = this.lado2
            this.lado2 = placeholder
          }

        }
      }

      function mostrarPecas(arrayPecas,tamanho,i){

        if (i < tamanho){
          let peca = new Image()
          peca.src = imagensPecas[arrayPecas[i].numero]
          let pecaObj = arrayPecas[i]
          let img_x = pecaObj.x
          let img_y = pecaObj.y

          ctx.save()

          if(pecaObj.posicao == "vertical"){
            ctx.translate(centro_x,centro_y)
            ctx.rotate(Math.PI/2)
            ctx.translate(-centro_x,-centro_y)
          }

          peca.addEventListener("load",()=>{
            ctx.drawImage(peca,img_x,img_y,pecaObj.larg,pecaObj.alt)
            ctx.restore()
            mostrarPecas(arrayPecas,tamanho,i+1)
            //Funcao recursiva garante que cada peca soh eh carregada
            //apos a peca anterior
          })
        }

      }



      let cadeiaPecas = new CadeiaDePecas()
      cadeiaPecas.PrimeiraPeca(numero="66")
      cadeiaPecas.MostrarCadeia()

      function atualizaTabuleiro(){

        var numeroEscolhido = document.getElementById("pecaJogador").value
        var pontaEscolhida = document.getElementById("pontaJogador").value

        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)

        if(pontaEscolhida==1){
          cadeiaPecas.AdicionaPonta1(numeroEscolhido)
        } else if (pontaEscolhida==2){
          cadeiaPecas.AdicionaPonta2(numeroEscolhido)
        }

        cadeiaPecas.MostrarCadeia()

      }

      function zoomOut(){
        ctx.clearRect(0,0,l_tabuleiro,a_tabuleiro)
        ctx.scale(.9,.9)
        cadeiaPecas.MostrarCadeia()
      }

    </script>

  </body>
</html>
